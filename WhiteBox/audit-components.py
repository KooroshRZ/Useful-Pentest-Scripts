import requests
import json
from time import sleep

def audit_packgejson():
    f = open("package.json")
    data = json.load(f)
    dependencies = data["dependencies"]
    devDependencies = data["devDependencies"]
    f.close()

    packages = {}

    for d in dependencies:
        packages[d] = dependencies[d][1:]
    for d in devDependencies:
        packages[d] = devDependencies[d][1:]
        
    # print(json.dumps(packages))
    # print(json.dumps(devDependencies))

    for p in packages:
        url = f"https://security.snyk.io/api/listing?search={p}&type=npm&pageNumber=1"
        vulnerabilities = json.loads(requests.get(url).text)["vulnerabilities"]

        # print(p)
        if len(vulnerabilities) > 0:
            print("*"*50)
            for vulnerability in vulnerabilities:
                title = vulnerability['title']
                severity = vulnerability['severity']
                packageName = vulnerability['packageName']
                version = vulnerability['semver']['vulnerable']
                if p == packageName:
                    print(f"[+] package \"{packageName}\"@{packages[p]} has \"{title}\" vulnerability with severity of {severity} : {version}")
            
            # print(p)
        
        sleep(1)
    
audit_packgejson()